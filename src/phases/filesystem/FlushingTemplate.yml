SchemaVersion: 2018-07-01
Owner: "@mongodb/server-perf"
Description: |
  This file defines a template to use to stress checkpointing, journal flush and dirty memory. The test itself is
  simple:
    - Run a single CrudActor targeting:
      - test database, configurable via the Database parameter.
      - Collection0 collection, configurable via the Collection parameter.
      - 10 threads, configurable via the Threads parameter.
      - 5000 iterations, configurable via the Iterations parameter.
      - 1500 documents, configurable via the Documents parameter.
      - 1 x 1000 bytes field in document, configurable via the DocumentSize parameter.
      - {w:majority} insert options, configurable via the Options parameter.
  

GlobalDefaults:
  - Database: &database test
  - Collection: &collection Collection0
  - &maxPhases 1
  - &insertThreads 10 # 10 # 25 # 100
  - &iterationsCount 5000
  - Options: &defaultOptions
      WriteConcern:
        Level: majority
  - &defaultDocument  # The size of each document is about 1kb.
      x: {^PreprocessorFormatString: {format: "%*s", withArgs: [999, "x" ]}}
      id: { ^Join: { array: [ { ^FormatString: { "format": "User%07d", "withArgs": [ { ^Inc: { start: 1 } } ] } } ] } }
  - &documentList10x {^FlattenOnce: [
      *defaultDocument,*defaultDocument,*defaultDocument,*defaultDocument,*defaultDocument,
      *defaultDocument,*defaultDocument,*defaultDocument,*defaultDocument,*defaultDocument,
  ]}
  - &documentsList100x {^FlattenOnce: [
      *documentList10x, *documentList10x, *documentList10x, *documentList10x, *documentList10x,
      *documentList10x, *documentList10x, *documentList10x, *documentList10x, *documentList10x,
  ]}
  - &defaultDocumentList {^FlattenOnce: [
      *documentsList100x, *documentsList100x, *documentsList100x, *documentsList100x, *documentsList100x,
      *documentsList100x, *documentsList100x, *documentsList100x, *documentsList100x, *documentsList100x,
      *documentsList100x, *documentsList100x, *documentsList100x, *documentsList100x, *documentsList100x,
  ]}

Actors:
  #  # Phase 0: insert.
  - Name: Insert
    Type: CrudActor
    Database: {^Parameter: {Name: "Database", Default: *database}}
    Threads: {^Parameter: {Name: "Threads", Default: *insertThreads}}
    Phases:
      OnlyActiveInPhases:
        Active: [0]
        NopInPhasesUpTo: *maxPhases
        PhaseConfig:
          Repeat: {^Parameter: {Name: "Iterations", Default: *iterationsCount}}
          Database: {^Parameter: {Name: "Database", Default: *database}}
          Collection:  {^Parameter: {Name: "Collection", Default: *collection}}
          Operations:
            - OperationMetricsName: insertMany
              OperationName: insertMany
              OperationCommand:
                Documents: {^Parameter: {Name: "Documents", Default: *defaultDocumentList}}
                Options: {^Parameter: {Name: "Options", Default: *defaultOptions}}
