SchemaVersion: 2018-07-01
Owner: "@mongodb/product-perf"
Description: |
  Phase definitions for comparative workloads.

GlobalDefaults:
  - &load_threads 16
  - &max_phases 14
  - &low_rate 200 per 1 second
  - &high_rate 1000 per 1 second
  - &no_rate 100%
  - &low_threads 2
  - &high_threads 16
  - &duration 180 seconds
  - &db_name test
  - &coll_name Collection0
  - &num_docs 1_000_000
  - &filter {_id: {^RandomInt: {min: 0, max: *num_docs}}}
  - &load_batch_size 1000
  - &insert_doc
    _id: {^Inc: {start: 0}}
  - &insert_one_doc
    id: {^Inc: {start: 0}}
  - &update_one_doc
    $set:
      ts: {^Now: {}}


# Parameterized Populate Collection Actor
PopulateCollectionActor:
  Name: PopulateCollection
  Type: Loader
  Threads: {^Parameter: {Name: "Threads", Default: *load_threads}}
  Database: {^Parameter: {Name: "Database", Default: *db_name}}
  ClientName: {^Parameter: {Name: "ClientName", Default: "Default"}}
  Phases:
    OnlyActiveInPhases:
      Active: {^Parameter: {Name: "Active", Default: [1]}}
      NopInPhasesUpTo: {^Parameter: {Name: "MaxPhases", Default: *max_phases}}
      PhaseConfig:
        Threads: { ^Parameter: { Name: "Threads", Default: *load_threads } }
        Database: *db_name
        CollectionCount: 1
        Repeat: 1
        Document: *insert_doc
        DocumentCount: {^Parameter: {Name: "DocumentCount", Default: *num_docs}}
        BatchSize: {^Parameter: {Name: "BatchSize", Default: *load_batch_size}}


#
# Actors
#
# Parameterized Ping Actor
#
PingActor:
  Name: {^Parameter: {Name: "Name", Default: "PingCommand"}}
  Type: RunCommand
  Threads: {^Parameter: {Name: "Threads", Default: *low_threads}}
  Database: {^Parameter: {Name: "Database", Default: *db_name}}
  ClientName: {^Parameter: {Name: "ClientName", Default: "Default"}}
  Phases:
    OnlyActiveInPhases:
      Active: {^Parameter: {Name: "Active", Default: [1]}}
      NopInPhasesUpTo: *max_phases
      PhaseConfig:
        GlobalRate: {^Parameter: {Name: "GlobalRate", Default: *low_rate}}
        Threads: {^Parameter: {Name: "Threads", Default: *low_threads}}
        Database: *db_name
        Collection: *coll_name
        Duration: {^Parameter: {Name: "Duration", Default: *duration}}
        Operations:
          - OperationName: RunCommand
            OperationIsQuiet: true
            OperationCommand:
              ping: 1
#
# CRUD Actors
#
# Parameterized Insert Actor
InsertOneActor:
  Name: {^Parameter: {Name: "Name", Default: "InsertOne"}}
  Type: CrudActor
  Threads: {^Parameter: {Name: "Threads", Default: *low_threads}}
  Database: {^Parameter: {Name: "Database", Default: *db_name}}
  ClientName: {^Parameter: {Name: "ClientName", Default: "Default"}}
  Phases:
    OnlyActiveInPhases:
      Active: {^Parameter: {Name: "Active", Default: [3]}}
      NopInPhasesUpTo: *max_phases
      PhaseConfig:
        GlobalRate: {^Parameter: {Name: "GlobalRate", Default: *low_rate}}
        Threads: {^Parameter: {Name: "Threads", Default: *low_threads}}
        Database: *db_name
        Collection: *coll_name
        Duration: {^Parameter: {Name: "Duration", Default: *duration}}
        Operations:
          ^Parameter:
            Name: Operations
            Default:
              - OperationName: insertOne
                OperationCommand:
                  Document: {^Parameter: {Name: "Document", Default: *insert_one_doc}}
                  OperationOptions:
                    WriteConcern:
                      Level: majority
                  Options:
                    Comment: {^Parameter: {Name: "Comment", Default: "Insert One"}}

# Parameterized Find Actor
FindOneActor:
  Name: {^Parameter: {Name: "Name", Default: "FindOne"}}
  Type: CrudActor
  Threads: {^Parameter: {Name: "Threads", Default: *low_threads}}
  Database: {^Parameter: {Name: "Database", Default: *db_name}}
  ClientName: {^Parameter: {Name: "ClientName", Default: "Default"}}
  Phases:
    OnlyActiveInPhases:
      Active: {^Parameter: {Name: "Active", Default: [3]}}
      NopInPhasesUpTo: *max_phases
      PhaseConfig:
        GlobalRate: {^Parameter: {Name: "GlobalRate", Default: *low_rate}}
        Threads: {^Parameter: {Name: "Threads", Default: *low_threads}}
        Database: *db_name
        Collection: *coll_name
        Duration: {^Parameter: {Name: "Duration", Default: *duration}}
        Operations:
          ^Parameter:
            Name: Operations
            Default:
              - OperationName: findOne
                OperationCommand:
                  Filter: {^Parameter: {Name: "Filter", Default: *filter}}
                  Options:
                    Comment: {^Parameter: {Name: "Comment", Default: "Find One"}}


# Parameterized Insert Actor
UpdateOneActor:
  Name: {^Parameter: {Name: "Name", Default: "InsertOne"}}
  Type: CrudActor
  Threads: {^Parameter: {Name: "Threads", Default: *low_threads}}
  Database: {^Parameter: {Name: "Database", Default: *db_name}}
  ClientName: {^Parameter: {Name: "ClientName", Default: "Default"}}
  Phases:
    OnlyActiveInPhases:
      Active: {^Parameter: {Name: "Active", Default: [3]}}
      NopInPhasesUpTo: *max_phases
      PhaseConfig:
        GlobalRate: {^Parameter: {Name: "GlobalRate", Default: *low_rate}}
        Threads: {^Parameter: {Name: "Threads", Default: *low_threads}}
        Database: *db_name
        Collection: *coll_name
        Duration: {^Parameter: {Name: "Duration", Default: *duration}}
        Operations:
          ^Parameter:
            Name: Operations
            Default:
              - OperationName: updateOne
                OperationCommand:
                  Filter: {^Parameter: {Name: "Filter", Default: *filter}}
                  Update: {^Parameter: {Name: "Update", Default: *update_one_doc}}
                  OperationOptions:
                    Upsert: false
                    WriteConcern:
                      Level: majority
                  Options:
                    Comment: {^Parameter: {Name: "Comment", Default: "Update One"}}


# Parameterized Insert Actor
DeleteOneActor:
  Name: {^Parameter: {Name: "Name", Default: "InsertOne"}}
  Type: CrudActor
  Threads: {^Parameter: {Name: "Threads", Default: *low_threads}}
  Database: {^Parameter: {Name: "Database", Default: *db_name}}
  ClientName: {^Parameter: {Name: "ClientName", Default: "Default"}}
  Phases:
    OnlyActiveInPhases:
      Active: {^Parameter: {Name: "Active", Default: [3]}}
      NopInPhasesUpTo: *max_phases
      PhaseConfig:
        GlobalRate: {^Parameter: {Name: "GlobalRate", Default: *low_rate}}
        Threads: {^Parameter: {Name: "Threads", Default: *low_threads}}
        Database: *db_name
        Collection: *coll_name
        Duration: {^Parameter: {Name: "Duration", Default: *duration}}
        Operations:
          ^Parameter:
            Name: Operations
            Default:
              - OperationName: deleteOne
                OperationCommand:
                  Filter: {^Parameter: {Name: "Filter", Default: *filter}}
                  OperationOptions:
                    WriteConcern:
                      Level: majority
                  Options:
                    Comment: {^Parameter: {Name: "Comment", Default: "Insert One"}}

# Parameterized Quiesce Actor
QuiesceActor:
  Name: {^Parameter: {Name: "Name", Default: "QuiesceOne"}}
  Type: QuiesceActor
  Threads: 1
  Database: {^Parameter: {Name: "Database", Default: *db_name}}
  Phases:
    OnlyActiveInPhases:
      Active: {^Parameter: {Name: "Active", Default: [0, 2, 4, 6, 8, 10, 12, 14]}}
      NopInPhasesUpTo: {^Parameter: {Name: "NopInPhasesUpTo", Default: *max_phases}}
      PhaseConfig:
        SleepBefore: 5 seconds
        SleepAfter: 5 seconds
        Repeat: 1


# Parameterized Hello Actor
HelloActor:
  Name: {^Parameter: {Name: "Name", Default: "Hello"}}
  Type: RunCommand
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: {^Parameter: {Name: "Active", Default: [0, 2, 4, 6, 8, 10]}}
      NopInPhasesUpTo: {^Parameter: {Name: "MaxPhases", Default: *max_phases}}
      PhaseConfig:
        SleepBefore: 1 seconds
        SleepAfter: 1 seconds
        Repeat: 1
        Database: test
        Operations:
          - OperationName: RunCommand
            OperationIsQuiet: true
            OperationCommand:
              hello: 1
              comment: {^Parameter: {Name: "Comment", Default: "comment"}}
