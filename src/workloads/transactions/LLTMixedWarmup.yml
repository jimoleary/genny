SchemaVersion: 2018-07-01
Owner: "@mongodb/product-perf"
Description: |
  Workload to Benchmark the effect of LongLivedTransactions on a Mixed workload. This version of the tests is less
  stressful (in terms of fitting into RAM) and has warmup phases.

GlobalDefaults:
  # Start: The following block gets updated for the other configurations.
  # db.stats() for the llt database:
  # * totalSize:    13.7  GiB.
  # * storageSize:   3    GiB.
  # * indexSize:    10.7  GiB.
  # * dataSize:      5.75 GiB.
  # * avgObjSize:  117 Bytes.
  InitialDocumentCount: &InitialNumDocs 6600000
  SecondaryDocumentCount: &SecondaryNumDocs 6600000
  GlobalRateValue: &GlobalRateValue 1 per 1250 microsecond
  ThreadsValue: &ThreadsValue 16
  # End: The previous block gets updated for the other configurations.

  # These values should match those are the top of LLTPhases.yml
  dbname: &dbname llt
  MaxPhases: &MaxPhases 25

  # The Sample Document Shape.
  Document: &Doc
    ts: {^Now: {}}
    caid: {^RandomInt: {min: 0, max: 1000}}
    cuid: {^RandomInt: {min: 0, max: 100000}}
    prod: {^RandomInt: {min: 0, max: 10000}}
    price: {^RandomDouble: {min: 0.0, max: 1000.0}}
    data: {^Join: {array: ["aaaaaaaaaa", {^FastRandomString: {length: {^RandomInt: {min: 0, max: 10}}}}]}}

  LLTIndexes: &LLTIndexes
  - keys: {price: 1, ts: 1, cuid: 1}     # Ptc
    options:
      name: price_1_ts_1_cuid_1
  - keys: {price: 1, cuid: 1}            # Pc
    options:
      name: price_1_cuid_1
  - keys: {caid: 1, price: 1, cuid: 1}   # Cpc
    options:
      name: caid_1_price_1_cuid_1

  # Loader Config.
  LoadThreads: &LoadThreads 4
  LoadBatchSize: &LoadBatchSize 1000

  CollectionCount: &CollectionCount 4

  # The write concern. The intent is to use what is chosen as the default in 5.0.
  # The query operation name indicates the index in use (see LLTIndexes) :
  #  * Ptc => price_1_ts_1_cuid_1
  #  * Pc  => price_1_cuid_1
  #  * Cpc => caid_1_price_1_cuid_1


  # Create
  InsertOperation: &InsertOperation
    OperationName: insertOne
    OperationCommand:
      Document: *Doc
      OperationOptions:
        WriteConcern:
          Level: majority

  # Read
  PtcQueryOperation: &PtcQueryOperation
    OperationName: findOne
    OperationCommand:
      Filter: {price: {$gte: {^RandomDouble: { min: 0.0, max: 500.0 }}}}
      Options:
        Hint: price_1_ts_1_cuid_1
        Comment: PtcQueryOperation

  PcQueryOperation: &PcQueryOperation
    OperationName: findOne
    OperationCommand:
      Filter: {price: {$gte: {^RandomDouble: { min: 0.0, max: 500.0 }}}}
      Options:
        Hint: price_1_cuid_1
        Comment: PcQueryOperation

  CpcQueryOperation: &CpcQueryOperation
    OperationName: findOne
    OperationCommand:
      Filter: {caid: {$gte: {^RandomInt: { min: 0, max: 1000 }}}}
      Options:
        Hint: caid_1_price_1_cuid_1
        Comment: CpcQueryOperation

  # Update
  PtcUpdateOperation: &PtcUpdateOperation
    OperationName: updateOne
    OperationCommand:
      Filter: {price: {$gte: {^RandomDouble: { min: 0.0, max: 500.0 }}}}
      Update:
        $set:
          ts: {^Now: {}}
          data: {^Join: {array: ["bbbbbbbbbb", {^FastRandomString: {length: {^RandomInt: {min: 0, max: 10}}}}]}}
      OperationOptions:
        Upsert: false
        WriteConcern:
          Level: majority
        Hint: price_1_ts_1_cuid_1

  PcUpdateOperation: &PcUpdateOperation
    OperationName: updateOne
    OperationCommand:
      Filter: {price: {$gte: {^RandomDouble: { min: 0.0, max: 500.0 }}}}
      Update:
        $set:
          ts: {^Now: {}}
          prod: {^RandomInt: {min: 0, max: 10000}}
      OperationOptions:
        Upsert: false
        WriteConcern:
          Level: majority
        Hint: price_1_cuid_1

  CpcUpdateOperation: &CpcUpdateOperation
    OperationName: updateOne
    OperationCommand:
      Filter: {caid: {$gte: {^RandomInt: { min: 0, max: 1000 }}}}
      Update:
        $set:
          ts: {^Now: {}}
          cuid: {^RandomInt: {min: 0, max: 100000}}
      OperationOptions:
        Upsert: false
        WriteConcern:
          Level: majority
        Hint: caid_1_price_1_cuid_1

  # Delete
  PtcRemoveOperation: &PtcRemoveOperation
    OperationName: deleteOne
    OperationCommand:
      Filter: {price: {$gte: {^RandomDouble: { min: 0.0, max: 1000.0 }}}}
      OperationOptions:
        Comment: PtcRemoveOperation
        WriteConcern:
          Level: majority

  PcRemoveOperation: &PcRemoveOperation
    OperationName: deleteOne
    OperationCommand:
      Filter: {price: {$gte: {^RandomDouble: { min: 0.0, max: 1000.0 }}}}
      OperationOptions:
        WriteConcern:
          Level: majority

  CpcRemoveOperation: &CpcRemoveOperation
    OperationName: deleteOne
    OperationCommand:
      Filter: {caid: {$gte: {^RandomInt: { min: 0, max: 1000 }}}}
      OperationOptions:
        WriteConcern:
          Level: majority

  # Scanner
  SnapshotScannerShortDuration: &SnapshotScannerShortDuration 1 minutes
  SnapshotScannerMediumDuration: &SnapshotScannerMediumDuration 10 minutes
  SnapshotScannerLongDuration: &SnapshotScannerLongDuration 60 minutes

ActorTemplates:
- TemplateName: InsertTemplate
  Config:
    Name: {^Parameter: {Name: "Name", Default: "Short.Insert.Baseline"}}
    Type: CrudActor
    Threads: *ThreadsValue
    Phases:
      OnlyActiveInPhases:
        Active: {^Parameter: {Name: "Active", Default: [9]}}
        NopInPhasesUpTo: *MaxPhases
        PhaseConfig:
          GlobalRate: *GlobalRateValue
          Threads: *ThreadsValue
          CollectionCount: *CollectionCount
          Database: *dbname
          Duration: {^Parameter: {Name: "Duration", Default: *SnapshotScannerShortDuration}}  # *SnapshotScannerShortDuration
          Blocking: {^Parameter: {Name: "Blocking", Default: true}}
          Operations:
          # Create
          - *InsertOperation
          - *InsertOperation
          - *InsertOperation
          - *InsertOperation
          - *InsertOperation
          - *InsertOperation

- TemplateName: QueryTemplate
  Config:
    Name: {^Parameter: {Name: "Name", Default: "Short.Query.Baseline"}}
    Type: CrudActor
    Threads: *ThreadsValue
    Phases:
      OnlyActiveInPhases:
        Active: {^Parameter: {Name: "Active", Default: [9]}}
        NopInPhasesUpTo: *MaxPhases
        PhaseConfig:
          GlobalRate: *GlobalRateValue
          Threads: *ThreadsValue
          CollectionCount: *CollectionCount
          Database: *dbname
          Duration: {^Parameter: {Name: "Duration", Default: *SnapshotScannerShortDuration}}  # *SnapshotScannerShortDuration
          Blocking: {^Parameter: {Name: "Blocking", Default: true}}
          Operations:
          # Read
          - *PtcQueryOperation
          - *PcQueryOperation
          - *CpcQueryOperation
          - *PtcQueryOperation
          - *PcQueryOperation
          - *CpcQueryOperation

- TemplateName: UpdateTemplate
  Config:
    Name: {^Parameter: {Name: "Name", Default: "Short.Update.Baseline"}}
    Type: CrudActor
    Threads: *ThreadsValue
    Phases:
      OnlyActiveInPhases:
        Active: {^Parameter: {Name: "Active", Default: [9]}}
        NopInPhasesUpTo: *MaxPhases
        PhaseConfig:
          GlobalRate: *GlobalRateValue
          Threads: *ThreadsValue
          CollectionCount: *CollectionCount
          Database: *dbname
          Duration: {^Parameter: {Name: "Duration", Default: *SnapshotScannerShortDuration}}  # *SnapshotScannerShortDuration
          Blocking: {^Parameter: {Name: "Blocking", Default: true}}
          Operations:
          # Update
          - *PtcUpdateOperation
          - *PcUpdateOperation
          - *CpcUpdateOperation
          - *PtcUpdateOperation
          - *PcUpdateOperation
          - *CpcUpdateOperation

- TemplateName: RemoveTemplate
  Config:
    Name: {^Parameter: {Name: "Name", Default: "Short.Remove.Baseline"}}
    Type: CrudActor
    Threads: *ThreadsValue
    Phases:
      OnlyActiveInPhases:
        Active: {^Parameter: {Name: "Active", Default: [9]}}
        NopInPhasesUpTo: *MaxPhases
        PhaseConfig:
          GlobalRate: *GlobalRateValue
          Threads: *ThreadsValue
          CollectionCount: *CollectionCount
          Database: *dbname
          Duration: {^Parameter: {Name: "Duration", Default: *SnapshotScannerShortDuration}}
          Blocking: {^Parameter: {Name: "Blocking", Default: true}}
          Operations:
          # Delete
          - *PtcRemoveOperation
          - *PcRemoveOperation
          - *CpcRemoveOperation
          - *PtcRemoveOperation
          - *PcRemoveOperation
          - *CpcRemoveOperation


- TemplateName: ScanTemplate
  Config:
    Name: {^Parameter: {Name: "Name", Default: "Short.Scan.Snapshot"}}
    Type: CollectionScanner
    Threads: *CollectionCount
    CollectionCount: *CollectionCount
    Database: *dbname
    GenerateCollectionNames: true
    Phases:
      OnlyActiveInPhases:
        Active: {^Parameter: {Name: "Active", Default: [12]}}
        NopInPhasesUpTo: *MaxPhases
        PhaseConfig:
          Duration: {^Parameter: {Name: "Duration", Default: *SnapshotScannerShortDuration}}
          ScanDuration: {^Parameter: {Name: "ScanDuration", Default: *SnapshotScannerShortDuration}}
          ScanType: snapshot
          ScanContinuous: true
          GenerateCollectionNames: true
          CollectionSortOrder: forward
          FindOptions:
            BatchSize: 1000
            Hint: _id_
            Comment: {^Parameter: {Name: "Comment", Default: "Scan.Snapshot"}}

Clients:
  Default:
    QueryOptions:
      socketTimeoutMS: -1
      maxPoolSize: 2000

# Phases:
# PhaseNumber % 3 == 0: Perform a task (and LoggingActor)
#    0: SetTransactionLifetimeLimit
#    3: Initial Document Load
#    6: Secondary Document Load
#    9: Short Baseline
#   12: Short Benchmark / Snapshot
#   15: Medium Baseline
#   18: Medium Benchmark / Snapshot
#   21: Long Baseline
#   24: Long Benchmark / Snapshot
# PhaseNumber % 3 == 1: Quiesce
# PhaseNumber % 3 == 2: Warmup
Actors:
# Ensure that transactionLifetimeLimitSeconds supports all the possible ScanDurations.
# i.e. greater than SnapshotScannerLongDuration.
- Name: SetTransactionLifetimeLimit
  Type: AdminCommand
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [0]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Operation:
          OperationName: RunCommand
          OperationCommand:
            setParameter: 1
            transactionLifetimeLimitSeconds: 14400  # 4 Hours

# Guard Against timeout for no output.
- Name: LoggingActor
  Type: LoggingActor
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [0, 3, 6, 9, 12, 15, 18, 21, 24]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        LogEvery: 15 minutes
        Blocking: None

- Name: QuiescePhase
  Type: QuiesceActor
  Threads: 1
  Database: *dbname
  Phases:
    OnlyActiveInPhases:
      Active: [1, 4, 7, 10, 13, 16, 19, 22, 25]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1

- Name: WarmUp
  Type: CollectionScanner
  Threads: *CollectionCount
  CollectionCount: *CollectionCount
  Database: *dbname
  GenerateCollectionNames: true
  Phases:
    OnlyActiveInPhases:
      Active: [2, 5, 8, 11, 14, 17, 20, 23]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        ScanType: standard
        GenerateCollectionNames: true
        Repeat: 1
        FindOptions:
          Comment: "WarmUp CollectionScanner"

- Name: InitialLoad
  Type: Loader
  Threads: *LoadThreads
  Phases:
    OnlyActiveInPhases:
      Active: [3]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Threads: *LoadThreads
        CollectionCount: *CollectionCount
        Database: *dbname
        Repeat: 1
        Document: *Doc
        DocumentCount: *InitialNumDocs
        Indexes: *LLTIndexes
        BatchSize: *LoadBatchSize

- Name: SecondLoadAfterIndexes
  Type: Loader
  Threads: *LoadThreads
  Phases:
    OnlyActiveInPhases:
      Active: [6]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Threads: *LoadThreads
        CollectionCount: *CollectionCount
        Database: *dbname
        Repeat: 1
        Document: *Doc
        DocumentCount: *SecondaryNumDocs
        BatchSize: *LoadBatchSize

# Naming Conventions:
# Operation.Duration.Load_level.Operation.Type_of_test
# Operation:     Insert|Query|Update|Remove|Mixed
# Duration:      Short|Medium|Long
# Type of test:  Baseline|Benchmark
#
# Baseline without scans, benchmark with scans
- ActorFromTemplate:
    TemplateName: InsertTemplate
    TemplateParameters:
      Name: Short.Insert.Baseline

- ActorFromTemplate:
    TemplateName: QueryTemplate
    TemplateParameters:
      Name: Short.Query.Baseline

- ActorFromTemplate:
    TemplateName: UpdateTemplate
    TemplateParameters:
      Name: Short.Update.Baseline

- ActorFromTemplate:
    TemplateName: RemoveTemplate
    TemplateParameters:
      Name: Short.Remove.Baseline

- ActorFromTemplate:
    TemplateName: InsertTemplate
    TemplateParameters:
      Name: Short.Insert.Benchmark
      Active: [12]
      Blocking: none

- ActorFromTemplate:
    TemplateName: QueryTemplate
    TemplateParameters:
      Name: Short.Query.Benchmark
      Active: [12]
      Blocking: none

- ActorFromTemplate:
    TemplateName: UpdateTemplate
    TemplateParameters:
      Name: Short.Update.Benchmark
      Active: [12]
      Blocking: none

- ActorFromTemplate:
    TemplateName: RemoveTemplate
    TemplateParameters:
      Name: Short.Remove.Benchmark
      Active: [12]
      Blocking: none

## A thread per collection doing a scan.
- ActorFromTemplate:
    TemplateName: ScanTemplate
    TemplateParameters:
      Name: Short.Scan.Snapshot
      Active: [12]
      Comment: SnapshotScannerShort

- ActorFromTemplate:
    TemplateName: InsertTemplate
    TemplateParameters:
      Name: Medium.Insert.Baseline
      Active: [15]
      Duration: *SnapshotScannerMediumDuration

- ActorFromTemplate:
    TemplateName: QueryTemplate
    TemplateParameters:
      Name: Medium.Query.Baseline
      Active: [15]
      Duration: *SnapshotScannerMediumDuration

- ActorFromTemplate:
    TemplateName: UpdateTemplate
    TemplateParameters:
      Name: Medium.Update.Baseline
      Active: [15]
      Duration: *SnapshotScannerMediumDuration

- ActorFromTemplate:
    TemplateName: RemoveTemplate
    TemplateParameters:
      Name: Medium.Remove.Baseline
      Active: [15]
      Duration: *SnapshotScannerMediumDuration

- ActorFromTemplate:
    TemplateName: InsertTemplate
    TemplateParameters:
      Name: Medium.Insert.Benchmark
      Active: [18]
      Blocking: none
      Duration: *SnapshotScannerMediumDuration

- ActorFromTemplate:
    TemplateName: QueryTemplate
    TemplateParameters:
      Name: Medium.Query.Benchmark
      Active: [18]
      Blocking: none
      Duration: *SnapshotScannerMediumDuration

- ActorFromTemplate:
    TemplateName: UpdateTemplate
    TemplateParameters:
      Name: Medium.Update.Benchmark
      Active: [18]
      Blocking: none
      Duration: *SnapshotScannerMediumDuration

- ActorFromTemplate:
    TemplateName: RemoveTemplate
    TemplateParameters:
      Name: Medium.Remove.Benchmark
      Active: [18]
      Blocking: none
      Duration: *SnapshotScannerMediumDuration

# A thread per collection doing a scan.
- ActorFromTemplate:
    TemplateName: ScanTemplate
    TemplateParameters:
      Name: Medium.Scan.Snapshot
      Active: [18]
      Comment: SnapshotScannerMedium
      Duration: *SnapshotScannerMediumDuration
      ScanDuration: *SnapshotScannerMediumDuration

- ActorFromTemplate:
    TemplateName: InsertTemplate
    TemplateParameters:
      Name: Long.Insert.Baseline
      Active: [21]
      Duration: *SnapshotScannerLongDuration

- ActorFromTemplate:
    TemplateName: QueryTemplate
    TemplateParameters:
      Name: Long.Query.Baseline
      Active: [21]
      Duration: *SnapshotScannerLongDuration

- ActorFromTemplate:
    TemplateName: UpdateTemplate
    TemplateParameters:
      Name: Long.Update.Baseline
      Active: [21]
      Duration: *SnapshotScannerLongDuration

- ActorFromTemplate:
    TemplateName: RemoveTemplate
    TemplateParameters:
      Name: Long.Remove.Baseline
      Active: [21]
      Duration: *SnapshotScannerLongDuration

- ActorFromTemplate:
    TemplateName: InsertTemplate
    TemplateParameters:
      Name: Long.Insert.Benchmark
      Active: [24]
      Blocking: none
      Duration: *SnapshotScannerLongDuration

- ActorFromTemplate:
    TemplateName: QueryTemplate
    TemplateParameters:
      Name: Long.Query.Benchmark
      Active: [24]
      Blocking: none
      Duration: *SnapshotScannerLongDuration

- ActorFromTemplate:
    TemplateName: UpdateTemplate
    TemplateParameters:
      Name: Long.Update.Benchmark
      Active: [24]
      Blocking: none
      Duration: *SnapshotScannerLongDuration

- ActorFromTemplate:
    TemplateName: RemoveTemplate
    TemplateParameters:
      Name: Long.Remove.Benchmark
      Active: [24]
      Blocking: none
      Duration: *SnapshotScannerLongDuration

# A thread per collection doing a scan.
- ActorFromTemplate:
    TemplateName: ScanTemplate
    TemplateParameters:
      Name: Long.Scan.Snapshot
      Active: [24]
      Comment: SnapshotScannerLong
      Duration: *SnapshotScannerLongDuration
      ScanDuration: *SnapshotScannerLongDuration

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - atlas-like-replica
      - replica
      - replica-all-feature-flags
      - single-replica
    branch_name:
      $neq:
      - v4.0
      - v4.2
