SchemaVersion: 2018-07-01
Owner: "@mongodb/sharding"
Description: |
  TODO: Write a description.

GlobalDefaults:
  Nop: &Nop {Nop: true}

  Database: &Database test
  # Collection0 and Collection1 are the collection names generated by the Loader.
  ShardedCollection: &ShardedCollection Collection0
  UnshardedCollection: &UnshardedCollection Collection1

  ShardedNamespace: &ShardedNamespace test.Collection0
  UnshardedNamespace: &UnshardedNamespace test.Collection1

  # Note that the exact document size may exceed ApproxDocumentSize because of field names and other
  # fields in the document.
  ApproxDocumentSize: &ApproxDocumentSize 500  # = 500B
  DocumentCount: &DocumentCount 100  # for an approximate total of 50KB

  ShardKeyValueMin: &ShardKeyValueMin 1
  ShardKeyValueMax: &ShardKeyValueMax 100

  ReadOperations: &ReadOperations
  - OperationName: findOne
    OperationCommand:
      Filter: {sk: {^RandomInt: {min: *ShardKeyValueMin, max: *ShardKeyValueMax}}}

  LoggerPhase: &LoggerPhase
    LogEvery: 1 minute # TimeSpec
    Blocking: None # must be Blocking:None


Clients:
  Default:
    QueryOptions:
      maxPoolSize: 1600

Actors:
- Name: CreateShardedCollection
  Type: AdminCommand
  Threads: 1
  Phases:
  - Repeat: 1
    Database: admin
    Operations:
    - OperationMetricsName: EnableSharding
      OperationName: AdminCommand
      OperationCommand:
        enableSharding: *Database
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: *ShardedNamespace
        key: {sk: hashed}
  - *Nop
  - *Nop
  - *Nop

- Name: LoadInitialData
  Type: Loader
  Threads: 2
  Phases:
  - *Nop
  - Repeat: 1
    BatchSize: 1000
    Threads: 2
    DocumentCount: *DocumentCount
    Database: *Database
    CollectionCount: 2
    Document:
      sk: {^RandomInt: {min: *ShardKeyValueMin, max: *ShardKeyValueMax}}
      padding: {^FastRandomString: {length: *ApproxDocumentSize, alphabet: x}}
    Indexes:
    - keys: {sk: 1}
  - *Nop
  - *Nop

- Name: ReadUnshardedCollection
  Type: CrudActor
  Threads: 400
  Database: *Database
  Phases:
  - *Nop
  - *Nop
  - MetricsName: UnshardedOnly
    Duration: 1 minute
    GlobalRate: 1 per 250 microseconds
    Collection: *UnshardedCollection
    Operations: *ReadOperations
  - MetricsName: BothUnshardedAndSharded
    Duration: 3 minutes
    GlobalRate: 1 per 2500 microseconds
    Collection: *UnshardedCollection
    Operations: *ReadOperations

- Name: ReadShardedCollection
  Type: CrudActor
  Threads: 400
  Database: *Database
  Phases:
  - *Nop
  - *Nop
  - *Nop
  - MetricsName: BothUnshardedAndSharded
    Duration: 3 minutes
    GlobalRate: 1 per 278 microseconds
    Collection: *ShardedCollection
    Operations:
    - OperationName: findOne
      OperationCommand:
        Filter:
          sk: {^RandomInt: {min: *ShardKeyValueMin, max: *ShardKeyValueMax}}
          $where: "function() { sleep(50); return true; }"

  # to avoid connection closing
- Name: LoggingActor
  Type: LoggingActor
  Threads: 1 # must be 1
  Phases:
    - *LoggerPhase
    - *LoggerPhase
    - *LoggerPhase
    - *LoggerPhase


AutoRun:
  - When:
      mongodb_setup:
        $eq:
          - shard
          - shard-lite
