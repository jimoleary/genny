SchemaVersion: 2018-07-01
Owner: "@mongodb/product-perf"
Description: >
  This is a simple test that runs a find on MongoDB to measure the latency of command dispatch.

Clients:
  Default:
    QueryOptions:
      maxPoolSize: 500

WorkloadDefaults:
  - &path ../../phases/comparative/Operations.yml
  - &low_rate 200 per 1 second
  - &high_rate 1000 per 1 second
  - &no_rate 100%
  - &low_threads 2
  - &high_threads 16
  # Rather than trying to figure out how much data to populate, we just issue deletes most of which do not find anything.
  # However, we can change num_docs to a large number to make most deletes find something. Something like 2x filter_docs
  # might work.
  # For now though, to ensure the tcpdump is not too large, this workload just issues deletes.
  - &num_docs 1
  - &filter_docs 50_000_000
  - &filter {_id: {$gte: {^RandomInt: {min: 0, max: *filter_docs}}}}


# Even Phases are Quiesce
# Odd Phases are setup (phase 1) or test.
Actors:
  - LoadConfig:
      Path: *path
      Key: QuiesceActor
  - LoadConfig:
      Path: *path
      Key: PopulateCollectionActor
      Parameters:
        Threads: *high_threads
        DocumentCount: *num_docs
  # Quiesce in phase [2]
  - LoadConfig:
      Path: *path
      Key: DeleteOneActor
      Parameters:
        Name: DeleteOneLowThreadLowRate
        Active: [3]
        Threads: *low_threads
        GlobalRate: *low_rate
        Filter: *filter
        Comment: Delete One Low Thread Low Rate
  # Quiesce in phase [4]
  - LoadConfig:
      Path: *path
      Key: DeleteOneActor
      Parameters:
        Name: DeleteOneLowThreadHighRate
        Active: [5]
        Threads: *low_threads
        GlobalRate: *high_rate
        Filter: *filter
        Comment: Delete One Low Thread High Rate
  # Quiesce in phase [6]
  - LoadConfig:
      Path: *path
      Key: DeleteOneActor
      Parameters:
        Name: DeleteOneLowThreadNoRate
        Active: [7]
        Threads: *low_threads
        GlobalRate: *no_rate
        Filter: *filter
        Comment: Delete One Low Thread No Rate
  # Quiesce in phase [8]
  - LoadConfig:
      Path: *path
      Key: DeleteOneActor
      Parameters:
        Name: DeleteOneHighThreadLowRate
        Active: [9]
        Threads: *high_threads
        GlobalRate: *low_rate
        Filter: *filter
        Comment: Delete One High Thread Low Rate
  # Quiesce in phase [10]
  - LoadConfig:
      Path: *path
      Key: DeleteOneActor
      Parameters:
        Name: DeleteOneHighThreadHighRate
        Active: [11]
        Threads: *high_threads
        GlobalRate: *high_rate
        Filter: *filter
        Comment: Delete One High Thread High Rate
  # Quiesce in phase [12]
  - LoadConfig:
      Path: *path
      Key: DeleteOneActor
      Parameters:
        Name: DeleteOneHighThreadNoRate
        Active: [13]
        Threads: *high_threads
        GlobalRate: *no_rate
        Filter: *filter
        Comment: Delete One High Thread No Rate
  # Quiesce in phase [14]

AutoRun:
  - When:
      mongodb_setup:
        $eq:
          - replica
