SchemaVersion: 2018-07-01
Owner: "@mongodb/product-perf"

# More threads requires a larger connection pool.
Clients:
  Default:
    QueryOptions:
      maxPoolSize: 200

Actors:
  - Name: MultipleCollectionsPerLoaderThread
    Type: Loader
    Threads: 10
    Phases:
      # If CollectionCount is less than the PhaseConfig Threads, then unexpected outcomes will occur.
      - Repeat: 1
        # create 6 collection (CollectionCount / PhaseConfig Threads) per thread over 10 threads.
        # Thread 0 creates collection 0 to 5
        # Thread 1 creates collection 6 to 11
        # etc.
        Database: hot
        CollectionCount: 6
        Threads: 1
        DocumentCount: 200000
        BatchSize: 100000
        Document:
          a: {^RandomString: { length: 100 }}
        FindOptions:
          Hint: a_index # Currently only support the index name.
          Comment: "Phase 1 loader"
        # Each thread creates the indexes for each collection it manages.
        Indexes:
          - keys: {a: 1}
            options: {name: "a_index"}
      - Repeat: 1
        # create 3 collection (CollectionCount / PhaseConfig Threads) per thread over 10 threads.
        # Thread 0 creates collection 0 to 2
        # Thread 1 creates collection 3 to 5
        # etc.
        Database: cold
        CollectionCount: 6
        Threads: 2
        DocumentCount: 200000
        BatchSize: 100000
        Document:
          a: {^RandomString: { length: 100 }}
      - Repeat: 1
        # create a single collection (CollectionCount / PhaseConfig Threads) per thread over 10 threads.
        # Thread 0 creates collection 0
        # Thread 1 creates collection 1
        # etc.
        Database: tepid
        CollectionCount: 6
        Threads: 6
        DocumentCount: 200000
        BatchSize: 100000
        Document:
          a: {^RandomString: { length: 100 }}
  - Name: MultipleLoadThreadsPerCollection
    Type: Loader
    Threads: 100
    Phases:
      - Repeat: 1
        Database: multithreaded
        # CollectionCount must be an even divisor of Threads.
        # Phase config cannot contain Threads if MultipleThreadsPerCollection is true.
        # Create 10 collections and populate with 10 threads per collection.
        MultipleThreadsPerCollection: true
        CollectionCount: 10
        # DocumentCount is the total document count. Each thread populate an equal fraction of the count.
        DocumentCount: 200000
        BatchSize: 1000
        Document:
          a: {^RandomString: { length: 100 }}
        FindOptions:
          Hint: a_index # Currently only support the index name.
          Comment: "Phase 1 loader"
        # Only one thread will create the indexes (for each collection).
        Indexes:
          - keys: {a: 1}
            options: {name: "a_index"}
      - {Nop: true}
      - {Nop: true}
